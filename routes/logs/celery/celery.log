[2021-01-22 02:58:53,037: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 02:58:53,205: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 02:58:54,339: INFO/MainProcess] mingle: all alone
[2021-01-22 02:58:54,367: INFO/MainProcess] celery@934dd4f4c7c3 ready.
[2021-01-22 02:58:56,603: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 02:59:45,023: INFO/MainProcess] Received task: create_task[5c5da19b-9529-4d42-8c63-112eeca32ae0]  
[2021-01-22 02:59:55,050: WARNING/ForkPoolWorker-7] [INFO - TASKTYPE] : 1
[2021-01-22 02:59:55,052: WARNING/ForkPoolWorker-7] [INFO - 2021-01-22 02:59:55.052382] -> @ Start pull data from Presto
[2021-01-22 02:59:55,054: INFO/ForkPoolWorker-7] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:01:17,340: WARNING/ForkPoolWorker-7] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 03:01:17,347: INFO/ForkPoolWorker-7] Task create_task[5c5da19b-9529-4d42-8c63-112eeca32ae0] succeeded in 92.30789319999894s: True
[2021-01-22 03:01:46,773: INFO/MainProcess] Received task: create_task[226984c9-b95d-4228-8774-17f84cf862ac]  
[2021-01-22 03:01:47,024: INFO/MainProcess] Received task: create_task[6bc3a990-9d52-4221-a3ab-7afafc21979d]  
[2021-01-22 03:01:47,747: INFO/MainProcess] Received task: create_task[f5a6766f-5ed8-46b2-a702-ee70c4ebae45]  
[2021-01-22 03:01:48,017: INFO/MainProcess] Received task: create_task[921e613a-3722-4ef0-aa66-cbd79a5b7820]  
[2021-01-22 03:01:56,792: WARNING/ForkPoolWorker-7] [INFO - TASKTYPE] : 1
[2021-01-22 03:01:56,793: WARNING/ForkPoolWorker-7] [INFO - 2021-01-22 03:01:56.793349] -> @ Start pull data from Presto
[2021-01-22 03:01:56,794: INFO/ForkPoolWorker-7] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:01:57,037: WARNING/ForkPoolWorker-8] [INFO - TASKTYPE] : 1
[2021-01-22 03:01:57,038: WARNING/ForkPoolWorker-8] [INFO - 2021-01-22 03:01:57.038528] -> @ Start pull data from Presto
[2021-01-22 03:01:57,041: INFO/ForkPoolWorker-8] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:01:57,757: WARNING/ForkPoolWorker-1] [INFO - TASKTYPE] : 1
[2021-01-22 03:01:57,761: WARNING/ForkPoolWorker-1] [INFO - 2021-01-22 03:01:57.761329] -> @ Start pull data from Presto
[2021-01-22 03:01:57,763: INFO/ForkPoolWorker-1] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:01:58,035: WARNING/ForkPoolWorker-2] [INFO - TASKTYPE] : 1
[2021-01-22 03:01:58,037: WARNING/ForkPoolWorker-2] [INFO - 2021-01-22 03:01:58.037393] -> @ Start pull data from Presto
[2021-01-22 03:01:58,039: INFO/ForkPoolWorker-2] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:02:33,455: WARNING/ForkPoolWorker-7] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 03:02:33,468: INFO/ForkPoolWorker-7] Task create_task[226984c9-b95d-4228-8774-17f84cf862ac] succeeded in 46.68635979999999s: True
[2021-01-22 03:02:33,986: WARNING/ForkPoolWorker-1] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 03:02:33,990: INFO/ForkPoolWorker-1] Task create_task[f5a6766f-5ed8-46b2-a702-ee70c4ebae45] succeeded in 46.23584730000039s: True
[2021-01-22 03:02:34,020: WARNING/ForkPoolWorker-2] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 03:02:34,021: WARNING/ForkPoolWorker-8] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 03:02:34,026: INFO/ForkPoolWorker-2] Task create_task[921e613a-3722-4ef0-aa66-cbd79a5b7820] succeeded in 46.00175429999945s: True
[2021-01-22 03:02:34,026: INFO/ForkPoolWorker-8] Task create_task[6bc3a990-9d52-4221-a3ab-7afafc21979d] succeeded in 46.9925647s: True
[2021-01-22 03:11:13,198: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 2.00 seconds... (1/100)

[2021-01-22 03:11:20,215: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 4.00 seconds... (2/100)

[2021-01-22 03:11:29,230: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 6.00 seconds... (3/100)

[2021-01-22 03:11:40,246: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 8.00 seconds... (4/100)

[2021-01-22 03:11:53,265: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 10.00 seconds... (5/100)

[2021-01-22 03:12:08,288: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 12.00 seconds... (6/100)

[2021-01-22 03:12:25,311: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 14.00 seconds... (7/100)

[2021-01-22 03:12:44,339: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 16.00 seconds... (8/100)

[2021-01-22 03:13:05,367: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 18.00 seconds... (9/100)

[2021-01-22 03:13:28,396: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 20.00 seconds... (10/100)

[2021-01-22 03:13:53,428: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 22.00 seconds... (11/100)

[2021-01-22 03:14:20,465: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 24.00 seconds... (12/100)

[2021-01-22 03:14:49,504: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 26.00 seconds... (13/100)

[2021-01-22 03:15:20,545: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 28.00 seconds... (14/100)

[2021-01-22 03:15:53,589: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 30.00 seconds... (15/100)

[2021-01-22 03:16:28,633: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 32.00 seconds... (16/100)

[2021-01-22 03:17:05,680: ERROR/MainProcess] consumer: Cannot connect to redis://redis:6379/0: Error -3 connecting to redis:6379. Try again..
Trying again in 32.00 seconds... (16/100)

[2021-01-22 03:17:40,448: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:17:40,469: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:17:41,513: INFO/MainProcess] mingle: all alone
[2021-01-22 03:17:41,527: INFO/MainProcess] celery@d4293447313d ready.
[2021-01-22 03:17:45,362: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:18:17,753: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:18:17,770: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:18:18,795: INFO/MainProcess] mingle: all alone
[2021-01-22 03:18:18,806: INFO/MainProcess] celery@ec8fee5f71bf ready.
[2021-01-22 03:18:37,434: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:18:37,447: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:18:38,517: INFO/MainProcess] mingle: all alone
[2021-01-22 03:18:38,537: INFO/MainProcess] celery@7de4f02ab1c1 ready.
[2021-01-22 03:18:42,350: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:19:31,653: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:19:31,684: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:19:31,747: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:19:31,770: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:19:31,773: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:19:31,794: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:19:32,752: INFO/MainProcess] mingle: all alone
[2021-01-22 03:19:32,766: INFO/MainProcess] celery@2d0d15030100 ready.
[2021-01-22 03:19:32,808: INFO/MainProcess] mingle: all alone
[2021-01-22 03:19:32,823: INFO/MainProcess] celery@9dcbeafaca97 ready.
[2021-01-22 03:19:32,832: INFO/MainProcess] mingle: all alone
[2021-01-22 03:19:32,850: INFO/MainProcess] celery@83f4c381ee0c ready.
[2021-01-22 03:19:36,375: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:19:36,375: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:19:36,375: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:20:11,242: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:20:11,324: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:20:12,014: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:20:12,126: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:20:12,143: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:20:12,231: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:20:12,439: INFO/MainProcess] mingle: all alone
[2021-01-22 03:20:12,559: INFO/MainProcess] celery@c780ccb0cd98 ready.
[2021-01-22 03:20:13,092: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:20:13,214: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:20:13,244: INFO/MainProcess] mingle: all alone
[2021-01-22 03:20:13,265: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:20:13,378: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:20:13,392: INFO/MainProcess] sync with celery@1994d31f38dd
[2021-01-22 03:20:13,406: INFO/MainProcess] celery@86211162ca05 ready.
[2021-01-22 03:20:13,408: INFO/MainProcess] mingle: all alone
[2021-01-22 03:20:13,552: INFO/MainProcess] sync with celery@4e5c34b1d409
[2021-01-22 03:20:13,548: INFO/MainProcess] sync with celery@4e5c34b1d409
[2021-01-22 03:20:13,627: INFO/MainProcess] celery@00ed9365cc2e ready.
[2021-01-22 03:20:13,663: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:20:13,760: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:20:13,884: INFO/MainProcess] sync with celery@a8624af92ed2
[2021-01-22 03:20:13,884: INFO/MainProcess] sync with celery@a8624af92ed2
[2021-01-22 03:20:13,882: INFO/MainProcess] sync with celery@a8624af92ed2
[2021-01-22 03:20:14,360: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:20:14,420: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:20:14,448: INFO/MainProcess] mingle: sync with 1 nodes
[2021-01-22 03:20:14,463: INFO/MainProcess] mingle: sync complete
[2021-01-22 03:20:14,525: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:20:14,541: INFO/MainProcess] celery@1994d31f38dd ready.
[2021-01-22 03:20:14,593: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:20:14,623: INFO/MainProcess] mingle: sync with 2 nodes
[2021-01-22 03:20:14,629: INFO/MainProcess] sync with celery@793bf9cb72b2
[2021-01-22 03:20:14,627: INFO/MainProcess] sync with celery@793bf9cb72b2
[2021-01-22 03:20:14,634: INFO/MainProcess] sync with celery@793bf9cb72b2
[2021-01-22 03:20:14,627: INFO/MainProcess] sync with celery@793bf9cb72b2
[2021-01-22 03:20:14,638: INFO/MainProcess] mingle: sync complete
[2021-01-22 03:20:14,715: INFO/MainProcess] celery@4e5c34b1d409 ready.
[2021-01-22 03:20:14,728: INFO/MainProcess] sync with celery@5d333b4dceef
[2021-01-22 03:20:14,728: INFO/MainProcess] sync with celery@5d333b4dceef
[2021-01-22 03:20:14,729: INFO/MainProcess] sync with celery@5d333b4dceef
[2021-01-22 03:20:14,729: INFO/MainProcess] sync with celery@5d333b4dceef
[2021-01-22 03:20:14,730: INFO/MainProcess] sync with celery@5d333b4dceef
[2021-01-22 03:20:14,751: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:20:14,758: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 03:20:14,784: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:20:14,788: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 03:20:14,831: INFO/MainProcess] sync with celery@ed6968ae9f44
[2021-01-22 03:20:14,831: INFO/MainProcess] sync with celery@ed6968ae9f44
[2021-01-22 03:20:14,831: INFO/MainProcess] sync with celery@ed6968ae9f44
[2021-01-22 03:20:14,832: INFO/MainProcess] sync with celery@ed6968ae9f44
[2021-01-22 03:20:14,832: INFO/MainProcess] sync with celery@ed6968ae9f44
[2021-01-22 03:20:14,840: INFO/MainProcess] sync with celery@fbfa7798e67e
[2021-01-22 03:20:14,840: INFO/MainProcess] sync with celery@fbfa7798e67e
[2021-01-22 03:20:14,841: INFO/MainProcess] sync with celery@fbfa7798e67e
[2021-01-22 03:20:14,840: INFO/MainProcess] sync with celery@fbfa7798e67e
[2021-01-22 03:20:14,842: INFO/MainProcess] sync with celery@fbfa7798e67e
[2021-01-22 03:20:14,919: INFO/MainProcess] mingle: sync with 3 nodes
[2021-01-22 03:20:14,920: INFO/MainProcess] mingle: sync complete
[2021-01-22 03:20:14,939: INFO/MainProcess] celery@a8624af92ed2 ready.
[2021-01-22 03:20:15,663: INFO/MainProcess] mingle: sync with 4 nodes
[2021-01-22 03:20:15,665: INFO/MainProcess] mingle: sync complete
[2021-01-22 03:20:15,687: INFO/MainProcess] celery@793bf9cb72b2 ready.
[2021-01-22 03:20:15,749: INFO/MainProcess] mingle: sync with 5 nodes
[2021-01-22 03:20:15,751: INFO/MainProcess] mingle: sync complete
[2021-01-22 03:20:15,772: INFO/MainProcess] celery@5d333b4dceef ready.
[2021-01-22 03:20:15,842: INFO/MainProcess] mingle: sync with 5 nodes
[2021-01-22 03:20:15,843: INFO/MainProcess] mingle: sync complete
[2021-01-22 03:20:15,852: INFO/MainProcess] mingle: sync with 5 nodes
[2021-01-22 03:20:15,855: INFO/MainProcess] mingle: sync complete
[2021-01-22 03:20:15,878: INFO/MainProcess] celery@ed6968ae9f44 ready.
[2021-01-22 03:20:15,890: INFO/MainProcess] celery@fbfa7798e67e ready.
[2021-01-22 03:20:20,003: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:20:20,003: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:20:20,003: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:20:20,003: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:20:20,003: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:20:20,004: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:20:20,003: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:20:20,004: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:20:20,004: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:20:20,003: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 03:20:53,990: INFO/MainProcess] Received task: create_task[692d40c8-11ea-42e4-ab4b-507f0ee81ac1]  
[2021-01-22 03:20:54,056: INFO/MainProcess] Received task: create_task[9032b2e3-bc88-4a09-bbf9-26555e3f47a0]  
[2021-01-22 03:20:54,185: INFO/MainProcess] Received task: create_task[f2683f95-4c85-41f9-a925-3f09eabf79f7]  
[2021-01-22 03:20:54,303: INFO/MainProcess] Received task: create_task[fa733614-7aac-4906-817f-6420f80f553e]  
[2021-01-22 03:20:54,415: INFO/MainProcess] Received task: create_task[4fc4d2c4-1952-4cfe-a4b1-daa18e812435]  
[2021-01-22 03:20:54,552: INFO/MainProcess] Received task: create_task[ac202d15-bfbe-4f6a-897d-71466c815d9b]  
[2021-01-22 03:20:54,672: INFO/MainProcess] Received task: create_task[b19da7cc-b97d-44c6-849e-3e7257e8f1af]  
[2021-01-22 03:20:54,810: INFO/MainProcess] Received task: create_task[916124c1-2d97-4801-b903-ae1dfac5b594]  
[2021-01-22 03:20:54,936: INFO/MainProcess] Received task: create_task[a1f9701d-dd20-486d-8fde-86a8bac0359a]  
[2021-01-22 03:20:55,059: INFO/MainProcess] Received task: create_task[75d7797a-31fc-43d5-a56c-09e79a92c1ba]  
[2021-01-22 03:20:55,206: INFO/MainProcess] Received task: create_task[52839b5b-6037-4788-a109-82da93b757e9]  
[2021-01-22 03:20:55,299: INFO/MainProcess] Received task: create_task[e76eb3d1-995f-457a-a06a-56659fe12964]  
[2021-01-22 03:20:55,426: INFO/MainProcess] Received task: create_task[f438b728-f138-4dce-952a-69880c5dbe7b]  
[2021-01-22 03:21:04,007: WARNING/ForkPoolWorker-7] [INFO - TASKTYPE] : 1
[2021-01-22 03:21:04,012: WARNING/ForkPoolWorker-7] [INFO - 2021-01-22 03:21:04.012080] -> @ Start pull data from Presto
[2021-01-22 03:21:04,014: INFO/ForkPoolWorker-7] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:21:04,078: WARNING/ForkPoolWorker-7] [INFO - TASKTYPE] : 1
[2021-01-22 03:21:04,080: WARNING/ForkPoolWorker-7] [INFO - 2021-01-22 03:21:04.080342] -> @ Start pull data from Presto
[2021-01-22 03:21:04,083: INFO/ForkPoolWorker-7] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:21:04,211: WARNING/ForkPoolWorker-7] [INFO - TASKTYPE] : 1
[2021-01-22 03:21:04,214: WARNING/ForkPoolWorker-7] [INFO - 2021-01-22 03:21:04.214545] -> @ Start pull data from Presto
[2021-01-22 03:21:04,216: INFO/ForkPoolWorker-7] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:21:04,317: WARNING/ForkPoolWorker-7] [INFO - TASKTYPE] : 1
[2021-01-22 03:21:04,319: WARNING/ForkPoolWorker-7] [INFO - 2021-01-22 03:21:04.319500] -> @ Start pull data from Presto
[2021-01-22 03:21:04,321: INFO/ForkPoolWorker-7] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:21:04,426: WARNING/ForkPoolWorker-7] [INFO - TASKTYPE] : 1
[2021-01-22 03:21:04,433: WARNING/ForkPoolWorker-7] [INFO - 2021-01-22 03:21:04.433318] -> @ Start pull data from Presto
[2021-01-22 03:21:04,440: INFO/ForkPoolWorker-7] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:21:04,566: WARNING/ForkPoolWorker-7] [INFO - TASKTYPE] : 1
[2021-01-22 03:21:04,568: WARNING/ForkPoolWorker-7] [INFO - 2021-01-22 03:21:04.568485] -> @ Start pull data from Presto
[2021-01-22 03:21:04,570: INFO/ForkPoolWorker-7] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:21:04,687: WARNING/ForkPoolWorker-8] [INFO - TASKTYPE] : 1
[2021-01-22 03:21:04,689: WARNING/ForkPoolWorker-8] [INFO - 2021-01-22 03:21:04.689696] -> @ Start pull data from Presto
[2021-01-22 03:21:04,691: INFO/ForkPoolWorker-8] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:21:04,828: WARNING/ForkPoolWorker-7] [INFO - TASKTYPE] : 1
[2021-01-22 03:21:04,831: WARNING/ForkPoolWorker-7] [INFO - 2021-01-22 03:21:04.831710] -> @ Start pull data from Presto
[2021-01-22 03:21:04,833: INFO/ForkPoolWorker-7] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:21:04,953: WARNING/ForkPoolWorker-7] [INFO - TASKTYPE] : 1
[2021-01-22 03:21:04,957: WARNING/ForkPoolWorker-7] [INFO - 2021-01-22 03:21:04.956183] -> @ Start pull data from Presto
[2021-01-22 03:21:04,961: INFO/ForkPoolWorker-7] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:21:05,082: WARNING/ForkPoolWorker-8] [INFO - TASKTYPE] : 1
[2021-01-22 03:21:05,088: WARNING/ForkPoolWorker-8] [INFO - 2021-01-22 03:21:05.088022] -> @ Start pull data from Presto
[2021-01-22 03:21:05,090: INFO/ForkPoolWorker-8] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:21:05,225: WARNING/ForkPoolWorker-8] [INFO - TASKTYPE] : 1
[2021-01-22 03:21:05,227: WARNING/ForkPoolWorker-8] [INFO - 2021-01-22 03:21:05.227460] -> @ Start pull data from Presto
[2021-01-22 03:21:05,231: INFO/ForkPoolWorker-8] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:21:05,317: WARNING/ForkPoolWorker-8] [INFO - TASKTYPE] : 1
[2021-01-22 03:21:05,319: WARNING/ForkPoolWorker-8] [INFO - 2021-01-22 03:21:05.319571] -> @ Start pull data from Presto
[2021-01-22 03:21:05,322: INFO/ForkPoolWorker-8] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:21:05,437: WARNING/ForkPoolWorker-8] [INFO - TASKTYPE] : 1
[2021-01-22 03:21:05,444: WARNING/ForkPoolWorker-8] [INFO - 2021-01-22 03:21:05.444571] -> @ Start pull data from Presto
[2021-01-22 03:21:05,451: INFO/ForkPoolWorker-8] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 03:21:59,166: ERROR/ForkPoolWorker-8] Task create_task[f438b728-f138-4dce-952a-69880c5dbe7b] raised unexpected: DatabaseError({'message': 'Query killed. Message: Killed via web UI', 'errorCode': 38, 'errorName': 'ADMINISTRATIVELY_KILLED', 'errorType': 'USER_ERROR', 'failureInfo': {'type': 'com.facebook.presto.spi.PrestoException', 'message': 'Query killed. Message: Killed via web UI', 'suppressed': [], 'stack': ['com.facebook.presto.connector.system.KillQueryProcedure.createKillQueryException(KillQueryProcedure.java:92)', 'com.facebook.presto.server.QueryResource.killQuery(QueryResource.java:96)', 'sun.reflect.GeneratedMethodAccessor1685.invoke(Unknown Source)', 'sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)', 'java.lang.reflect.Method.invoke(Method.java:498)', 'org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory.lambda$static$0(ResourceMethodInvocationHandlerFactory.java:76)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:148)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:191)', 'org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$ResponseOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:200)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:103)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:493)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:415)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:104)', 'org.glassfish.jersey.server.ServerRuntime$1.run(ServerRuntime.java:277)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:272)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:268)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:316)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:298)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:268)', 'org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:289)', 'org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:256)', 'org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:703)', 'org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:416)', 'org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:370)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:389)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:342)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:229)', 'org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:867)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1623)', 'com.facebook.presto.server.security.AuthenticationFilter.doFilter(AuthenticationFilter.java:69)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TraceTokenFilter.doFilter(TraceTokenFilter.java:63)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TimingFilter.doFilter(TimingFilter.java:51)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:540)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)', 'org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:703)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)', 'org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1345)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)', 'org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:480)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)', 'org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1247)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)', 'org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)', 'org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:174)', 'org.eclipse.jetty.server.handler.HandlerList.handle(HandlerList.java:61)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.Server.handle(Server.java:502)', 'org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:364)', 'org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)', 'org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ssl.SslConnection$DecryptedEndPoint.onFillable(SslConnection.java:411)', 'org.eclipse.jetty.io.ssl.SslConnection.onFillable(SslConnection.java:305)', 'org.eclipse.jetty.io.ssl.SslConnection$2.succeeded(SslConnection.java:159)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)', 'org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)', 'org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:765)', 'org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:683)', 'java.lang.Thread.run(Thread.java:748)']}})
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/site-packages/celery/app/trace.py", line 412, in trace_task
    R = retval = fun(*args, **kwargs)
  File "/usr/local/lib/python3.8/site-packages/celery/app/trace.py", line 704, in __protected_call__
    return self.run(*args, **kwargs)
  File "/usr/src/app/routes/server/tasks.py", line 34, in create_task
    df = pd.read_sql(gen_sql(), presto_conn)
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 484, in read_sql
    return pandas_sql.read_query(
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 1756, in read_query
    data = self._fetchall_as_list(cursor)
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 1769, in _fetchall_as_list
    result = cur.fetchall()
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 137, in fetchall
    return list(iter(self.fetchone, None))
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 106, in fetchone
    self._fetch_while(lambda: not self._data and self._state != self._STATE_FINISHED)
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 46, in _fetch_while
    self._fetch_more()
  File "/usr/local/lib/python3.8/site-packages/pyhive/presto.py", line 308, in _fetch_more
    self._process_response(self._requests_session.get(self._nextUri, **self._requests_kwargs))
  File "/usr/local/lib/python3.8/site-packages/pyhive/presto.py", line 349, in _process_response
    raise DatabaseError(response_json['error'])
pyhive.exc.DatabaseError: {'message': 'Query killed. Message: Killed via web UI', 'errorCode': 38, 'errorName': 'ADMINISTRATIVELY_KILLED', 'errorType': 'USER_ERROR', 'failureInfo': {'type': 'com.facebook.presto.spi.PrestoException', 'message': 'Query killed. Message: Killed via web UI', 'suppressed': [], 'stack': ['com.facebook.presto.connector.system.KillQueryProcedure.createKillQueryException(KillQueryProcedure.java:92)', 'com.facebook.presto.server.QueryResource.killQuery(QueryResource.java:96)', 'sun.reflect.GeneratedMethodAccessor1685.invoke(Unknown Source)', 'sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)', 'java.lang.reflect.Method.invoke(Method.java:498)', 'org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory.lambda$static$0(ResourceMethodInvocationHandlerFactory.java:76)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:148)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:191)', 'org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$ResponseOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:200)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:103)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:493)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:415)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:104)', 'org.glassfish.jersey.server.ServerRuntime$1.run(ServerRuntime.java:277)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:272)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:268)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:316)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:298)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:268)', 'org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:289)', 'org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:256)', 'org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:703)', 'org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:416)', 'org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:370)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:389)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:342)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:229)', 'org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:867)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1623)', 'com.facebook.presto.server.security.AuthenticationFilter.doFilter(AuthenticationFilter.java:69)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TraceTokenFilter.doFilter(TraceTokenFilter.java:63)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TimingFilter.doFilter(TimingFilter.java:51)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:540)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)', 'org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:703)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)', 'org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1345)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)', 'org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:480)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)', 'org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1247)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)', 'org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)', 'org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:174)', 'org.eclipse.jetty.server.handler.HandlerList.handle(HandlerList.java:61)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.Server.handle(Server.java:502)', 'org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:364)', 'org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)', 'org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ssl.SslConnection$DecryptedEndPoint.onFillable(SslConnection.java:411)', 'org.eclipse.jetty.io.ssl.SslConnection.onFillable(SslConnection.java:305)', 'org.eclipse.jetty.io.ssl.SslConnection$2.succeeded(SslConnection.java:159)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)', 'org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)', 'org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:765)', 'org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:683)', 'java.lang.Thread.run(Thread.java:748)']}}
[2021-01-22 03:22:11,330: ERROR/ForkPoolWorker-7] Task create_task[a1f9701d-dd20-486d-8fde-86a8bac0359a] raised unexpected: DatabaseError({'message': 'Query killed. Message: Killed via web UI', 'errorCode': 38, 'errorName': 'ADMINISTRATIVELY_KILLED', 'errorType': 'USER_ERROR', 'failureInfo': {'type': 'com.facebook.presto.spi.PrestoException', 'message': 'Query killed. Message: Killed via web UI', 'suppressed': [], 'stack': ['com.facebook.presto.connector.system.KillQueryProcedure.createKillQueryException(KillQueryProcedure.java:92)', 'com.facebook.presto.server.QueryResource.killQuery(QueryResource.java:96)', 'sun.reflect.GeneratedMethodAccessor1685.invoke(Unknown Source)', 'sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)', 'java.lang.reflect.Method.invoke(Method.java:498)', 'org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory.lambda$static$0(ResourceMethodInvocationHandlerFactory.java:76)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:148)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:191)', 'org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$ResponseOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:200)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:103)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:493)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:415)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:104)', 'org.glassfish.jersey.server.ServerRuntime$1.run(ServerRuntime.java:277)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:272)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:268)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:316)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:298)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:268)', 'org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:289)', 'org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:256)', 'org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:703)', 'org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:416)', 'org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:370)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:389)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:342)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:229)', 'org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:867)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1623)', 'com.facebook.presto.server.security.AuthenticationFilter.doFilter(AuthenticationFilter.java:69)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TraceTokenFilter.doFilter(TraceTokenFilter.java:63)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TimingFilter.doFilter(TimingFilter.java:51)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:540)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)', 'org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:703)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)', 'org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1345)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)', 'org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:480)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)', 'org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1247)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)', 'org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)', 'org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:174)', 'org.eclipse.jetty.server.handler.HandlerList.handle(HandlerList.java:61)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.Server.handle(Server.java:502)', 'org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:364)', 'org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)', 'org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ssl.SslConnection$DecryptedEndPoint.onFillable(SslConnection.java:411)', 'org.eclipse.jetty.io.ssl.SslConnection.onFillable(SslConnection.java:305)', 'org.eclipse.jetty.io.ssl.SslConnection$2.succeeded(SslConnection.java:159)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)', 'org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)', 'org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:765)', 'org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:683)', 'java.lang.Thread.run(Thread.java:748)']}})
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/site-packages/celery/app/trace.py", line 412, in trace_task
    R = retval = fun(*args, **kwargs)
  File "/usr/local/lib/python3.8/site-packages/celery/app/trace.py", line 704, in __protected_call__
    return self.run(*args, **kwargs)
  File "/usr/src/app/routes/server/tasks.py", line 34, in create_task
    df = pd.read_sql(gen_sql(), presto_conn)
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 484, in read_sql
    return pandas_sql.read_query(
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 1756, in read_query
    data = self._fetchall_as_list(cursor)
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 1769, in _fetchall_as_list
    result = cur.fetchall()
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 137, in fetchall
    return list(iter(self.fetchone, None))
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 106, in fetchone
    self._fetch_while(lambda: not self._data and self._state != self._STATE_FINISHED)
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 46, in _fetch_while
    self._fetch_more()
  File "/usr/local/lib/python3.8/site-packages/pyhive/presto.py", line 308, in _fetch_more
    self._process_response(self._requests_session.get(self._nextUri, **self._requests_kwargs))
  File "/usr/local/lib/python3.8/site-packages/pyhive/presto.py", line 349, in _process_response
    raise DatabaseError(response_json['error'])
pyhive.exc.DatabaseError: {'message': 'Query killed. Message: Killed via web UI', 'errorCode': 38, 'errorName': 'ADMINISTRATIVELY_KILLED', 'errorType': 'USER_ERROR', 'failureInfo': {'type': 'com.facebook.presto.spi.PrestoException', 'message': 'Query killed. Message: Killed via web UI', 'suppressed': [], 'stack': ['com.facebook.presto.connector.system.KillQueryProcedure.createKillQueryException(KillQueryProcedure.java:92)', 'com.facebook.presto.server.QueryResource.killQuery(QueryResource.java:96)', 'sun.reflect.GeneratedMethodAccessor1685.invoke(Unknown Source)', 'sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)', 'java.lang.reflect.Method.invoke(Method.java:498)', 'org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory.lambda$static$0(ResourceMethodInvocationHandlerFactory.java:76)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:148)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:191)', 'org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$ResponseOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:200)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:103)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:493)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:415)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:104)', 'org.glassfish.jersey.server.ServerRuntime$1.run(ServerRuntime.java:277)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:272)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:268)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:316)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:298)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:268)', 'org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:289)', 'org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:256)', 'org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:703)', 'org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:416)', 'org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:370)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:389)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:342)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:229)', 'org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:867)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1623)', 'com.facebook.presto.server.security.AuthenticationFilter.doFilter(AuthenticationFilter.java:69)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TraceTokenFilter.doFilter(TraceTokenFilter.java:63)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TimingFilter.doFilter(TimingFilter.java:51)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:540)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)', 'org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:703)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)', 'org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1345)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)', 'org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:480)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)', 'org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1247)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)', 'org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)', 'org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:174)', 'org.eclipse.jetty.server.handler.HandlerList.handle(HandlerList.java:61)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.Server.handle(Server.java:502)', 'org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:364)', 'org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)', 'org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ssl.SslConnection$DecryptedEndPoint.onFillable(SslConnection.java:411)', 'org.eclipse.jetty.io.ssl.SslConnection.onFillable(SslConnection.java:305)', 'org.eclipse.jetty.io.ssl.SslConnection$2.succeeded(SslConnection.java:159)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)', 'org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)', 'org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:765)', 'org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:683)', 'java.lang.Thread.run(Thread.java:748)']}}
[2021-01-22 03:22:18,057: ERROR/ForkPoolWorker-8] Task create_task[b19da7cc-b97d-44c6-849e-3e7257e8f1af] raised unexpected: DatabaseError({'message': 'Query killed. Message: Killed via web UI', 'errorCode': 38, 'errorName': 'ADMINISTRATIVELY_KILLED', 'errorType': 'USER_ERROR', 'failureInfo': {'type': 'com.facebook.presto.spi.PrestoException', 'message': 'Query killed. Message: Killed via web UI', 'suppressed': [], 'stack': ['com.facebook.presto.connector.system.KillQueryProcedure.createKillQueryException(KillQueryProcedure.java:92)', 'com.facebook.presto.server.QueryResource.killQuery(QueryResource.java:96)', 'sun.reflect.GeneratedMethodAccessor1685.invoke(Unknown Source)', 'sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)', 'java.lang.reflect.Method.invoke(Method.java:498)', 'org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory.lambda$static$0(ResourceMethodInvocationHandlerFactory.java:76)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:148)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:191)', 'org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$ResponseOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:200)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:103)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:493)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:415)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:104)', 'org.glassfish.jersey.server.ServerRuntime$1.run(ServerRuntime.java:277)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:272)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:268)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:316)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:298)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:268)', 'org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:289)', 'org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:256)', 'org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:703)', 'org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:416)', 'org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:370)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:389)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:342)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:229)', 'org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:867)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1623)', 'com.facebook.presto.server.security.AuthenticationFilter.doFilter(AuthenticationFilter.java:69)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TraceTokenFilter.doFilter(TraceTokenFilter.java:63)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TimingFilter.doFilter(TimingFilter.java:51)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:540)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)', 'org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:703)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)', 'org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1345)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)', 'org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:480)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)', 'org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1247)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)', 'org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)', 'org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:174)', 'org.eclipse.jetty.server.handler.HandlerList.handle(HandlerList.java:61)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.Server.handle(Server.java:502)', 'org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:364)', 'org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)', 'org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ssl.SslConnection$DecryptedEndPoint.onFillable(SslConnection.java:411)', 'org.eclipse.jetty.io.ssl.SslConnection.onFillable(SslConnection.java:305)', 'org.eclipse.jetty.io.ssl.SslConnection$2.succeeded(SslConnection.java:159)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)', 'org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)', 'org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:765)', 'org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:683)', 'java.lang.Thread.run(Thread.java:748)']}})
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/site-packages/celery/app/trace.py", line 412, in trace_task
    R = retval = fun(*args, **kwargs)
  File "/usr/local/lib/python3.8/site-packages/celery/app/trace.py", line 704, in __protected_call__
    return self.run(*args, **kwargs)
  File "/usr/src/app/routes/server/tasks.py", line 34, in create_task
    df = pd.read_sql(gen_sql(), presto_conn)
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 484, in read_sql
    return pandas_sql.read_query(
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 1756, in read_query
    data = self._fetchall_as_list(cursor)
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 1769, in _fetchall_as_list
    result = cur.fetchall()
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 137, in fetchall
    return list(iter(self.fetchone, None))
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 106, in fetchone
    self._fetch_while(lambda: not self._data and self._state != self._STATE_FINISHED)
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 46, in _fetch_while
    self._fetch_more()
  File "/usr/local/lib/python3.8/site-packages/pyhive/presto.py", line 308, in _fetch_more
    self._process_response(self._requests_session.get(self._nextUri, **self._requests_kwargs))
  File "/usr/local/lib/python3.8/site-packages/pyhive/presto.py", line 349, in _process_response
    raise DatabaseError(response_json['error'])
pyhive.exc.DatabaseError: {'message': 'Query killed. Message: Killed via web UI', 'errorCode': 38, 'errorName': 'ADMINISTRATIVELY_KILLED', 'errorType': 'USER_ERROR', 'failureInfo': {'type': 'com.facebook.presto.spi.PrestoException', 'message': 'Query killed. Message: Killed via web UI', 'suppressed': [], 'stack': ['com.facebook.presto.connector.system.KillQueryProcedure.createKillQueryException(KillQueryProcedure.java:92)', 'com.facebook.presto.server.QueryResource.killQuery(QueryResource.java:96)', 'sun.reflect.GeneratedMethodAccessor1685.invoke(Unknown Source)', 'sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)', 'java.lang.reflect.Method.invoke(Method.java:498)', 'org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory.lambda$static$0(ResourceMethodInvocationHandlerFactory.java:76)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:148)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:191)', 'org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$ResponseOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:200)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:103)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:493)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:415)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:104)', 'org.glassfish.jersey.server.ServerRuntime$1.run(ServerRuntime.java:277)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:272)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:268)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:316)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:298)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:268)', 'org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:289)', 'org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:256)', 'org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:703)', 'org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:416)', 'org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:370)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:389)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:342)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:229)', 'org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:867)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1623)', 'com.facebook.presto.server.security.AuthenticationFilter.doFilter(AuthenticationFilter.java:69)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TraceTokenFilter.doFilter(TraceTokenFilter.java:63)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TimingFilter.doFilter(TimingFilter.java:51)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:540)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)', 'org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:703)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)', 'org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1345)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)', 'org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:480)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)', 'org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1247)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)', 'org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)', 'org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:174)', 'org.eclipse.jetty.server.handler.HandlerList.handle(HandlerList.java:61)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.Server.handle(Server.java:502)', 'org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:364)', 'org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)', 'org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ssl.SslConnection$DecryptedEndPoint.onFillable(SslConnection.java:411)', 'org.eclipse.jetty.io.ssl.SslConnection.onFillable(SslConnection.java:305)', 'org.eclipse.jetty.io.ssl.SslConnection$2.succeeded(SslConnection.java:159)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)', 'org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)', 'org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:765)', 'org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:683)', 'java.lang.Thread.run(Thread.java:748)']}}
[2021-01-22 03:22:26,437: ERROR/ForkPoolWorker-7] Task create_task[f2683f95-4c85-41f9-a925-3f09eabf79f7] raised unexpected: DatabaseError({'message': 'Query killed. Message: Killed via web UI', 'errorCode': 38, 'errorName': 'ADMINISTRATIVELY_KILLED', 'errorType': 'USER_ERROR', 'failureInfo': {'type': 'com.facebook.presto.spi.PrestoException', 'message': 'Query killed. Message: Killed via web UI', 'suppressed': [], 'stack': ['com.facebook.presto.connector.system.KillQueryProcedure.createKillQueryException(KillQueryProcedure.java:92)', 'com.facebook.presto.server.QueryResource.killQuery(QueryResource.java:96)', 'sun.reflect.GeneratedMethodAccessor1685.invoke(Unknown Source)', 'sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)', 'java.lang.reflect.Method.invoke(Method.java:498)', 'org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory.lambda$static$0(ResourceMethodInvocationHandlerFactory.java:76)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:148)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:191)', 'org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$ResponseOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:200)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:103)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:493)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:415)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:104)', 'org.glassfish.jersey.server.ServerRuntime$1.run(ServerRuntime.java:277)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:272)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:268)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:316)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:298)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:268)', 'org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:289)', 'org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:256)', 'org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:703)', 'org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:416)', 'org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:370)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:389)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:342)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:229)', 'org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:867)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1623)', 'com.facebook.presto.server.security.AuthenticationFilter.doFilter(AuthenticationFilter.java:69)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TraceTokenFilter.doFilter(TraceTokenFilter.java:63)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TimingFilter.doFilter(TimingFilter.java:51)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:540)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)', 'org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:703)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)', 'org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1345)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)', 'org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:480)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)', 'org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1247)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)', 'org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)', 'org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:174)', 'org.eclipse.jetty.server.handler.HandlerList.handle(HandlerList.java:61)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.Server.handle(Server.java:502)', 'org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:364)', 'org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)', 'org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ssl.SslConnection$DecryptedEndPoint.onFillable(SslConnection.java:411)', 'org.eclipse.jetty.io.ssl.SslConnection.onFillable(SslConnection.java:305)', 'org.eclipse.jetty.io.ssl.SslConnection$2.succeeded(SslConnection.java:159)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)', 'org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)', 'org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:765)', 'org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:683)', 'java.lang.Thread.run(Thread.java:748)']}})
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/site-packages/celery/app/trace.py", line 412, in trace_task
    R = retval = fun(*args, **kwargs)
  File "/usr/local/lib/python3.8/site-packages/celery/app/trace.py", line 704, in __protected_call__
    return self.run(*args, **kwargs)
  File "/usr/src/app/routes/server/tasks.py", line 34, in create_task
    df = pd.read_sql(gen_sql(), presto_conn)
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 484, in read_sql
    return pandas_sql.read_query(
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 1756, in read_query
    data = self._fetchall_as_list(cursor)
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 1769, in _fetchall_as_list
    result = cur.fetchall()
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 137, in fetchall
    return list(iter(self.fetchone, None))
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 106, in fetchone
    self._fetch_while(lambda: not self._data and self._state != self._STATE_FINISHED)
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 46, in _fetch_while
    self._fetch_more()
  File "/usr/local/lib/python3.8/site-packages/pyhive/presto.py", line 308, in _fetch_more
    self._process_response(self._requests_session.get(self._nextUri, **self._requests_kwargs))
  File "/usr/local/lib/python3.8/site-packages/pyhive/presto.py", line 349, in _process_response
    raise DatabaseError(response_json['error'])
pyhive.exc.DatabaseError: {'message': 'Query killed. Message: Killed via web UI', 'errorCode': 38, 'errorName': 'ADMINISTRATIVELY_KILLED', 'errorType': 'USER_ERROR', 'failureInfo': {'type': 'com.facebook.presto.spi.PrestoException', 'message': 'Query killed. Message: Killed via web UI', 'suppressed': [], 'stack': ['com.facebook.presto.connector.system.KillQueryProcedure.createKillQueryException(KillQueryProcedure.java:92)', 'com.facebook.presto.server.QueryResource.killQuery(QueryResource.java:96)', 'sun.reflect.GeneratedMethodAccessor1685.invoke(Unknown Source)', 'sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)', 'java.lang.reflect.Method.invoke(Method.java:498)', 'org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory.lambda$static$0(ResourceMethodInvocationHandlerFactory.java:76)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:148)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:191)', 'org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$ResponseOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:200)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:103)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:493)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:415)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:104)', 'org.glassfish.jersey.server.ServerRuntime$1.run(ServerRuntime.java:277)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:272)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:268)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:316)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:298)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:268)', 'org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:289)', 'org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:256)', 'org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:703)', 'org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:416)', 'org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:370)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:389)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:342)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:229)', 'org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:867)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1623)', 'com.facebook.presto.server.security.AuthenticationFilter.doFilter(AuthenticationFilter.java:69)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TraceTokenFilter.doFilter(TraceTokenFilter.java:63)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TimingFilter.doFilter(TimingFilter.java:51)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:540)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)', 'org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:703)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)', 'org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1345)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)', 'org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:480)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)', 'org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1247)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)', 'org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)', 'org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:174)', 'org.eclipse.jetty.server.handler.HandlerList.handle(HandlerList.java:61)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.Server.handle(Server.java:502)', 'org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:364)', 'org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)', 'org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ssl.SslConnection$DecryptedEndPoint.onFillable(SslConnection.java:411)', 'org.eclipse.jetty.io.ssl.SslConnection.onFillable(SslConnection.java:305)', 'org.eclipse.jetty.io.ssl.SslConnection$2.succeeded(SslConnection.java:159)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)', 'org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)', 'org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:765)', 'org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:683)', 'java.lang.Thread.run(Thread.java:748)']}}
[2021-01-22 03:22:39,637: ERROR/ForkPoolWorker-7] Task create_task[9032b2e3-bc88-4a09-bbf9-26555e3f47a0] raised unexpected: DatabaseError({'message': 'Query killed. Message: Killed via web UI', 'errorCode': 38, 'errorName': 'ADMINISTRATIVELY_KILLED', 'errorType': 'USER_ERROR', 'failureInfo': {'type': 'com.facebook.presto.spi.PrestoException', 'message': 'Query killed. Message: Killed via web UI', 'suppressed': [], 'stack': ['com.facebook.presto.connector.system.KillQueryProcedure.createKillQueryException(KillQueryProcedure.java:92)', 'com.facebook.presto.server.QueryResource.killQuery(QueryResource.java:96)', 'sun.reflect.GeneratedMethodAccessor1685.invoke(Unknown Source)', 'sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)', 'java.lang.reflect.Method.invoke(Method.java:498)', 'org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory.lambda$static$0(ResourceMethodInvocationHandlerFactory.java:76)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:148)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:191)', 'org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$ResponseOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:200)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:103)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:493)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:415)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:104)', 'org.glassfish.jersey.server.ServerRuntime$1.run(ServerRuntime.java:277)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:272)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:268)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:316)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:298)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:268)', 'org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:289)', 'org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:256)', 'org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:703)', 'org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:416)', 'org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:370)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:389)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:342)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:229)', 'org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:867)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1623)', 'com.facebook.presto.server.security.AuthenticationFilter.doFilter(AuthenticationFilter.java:69)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TraceTokenFilter.doFilter(TraceTokenFilter.java:63)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TimingFilter.doFilter(TimingFilter.java:51)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:540)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)', 'org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:703)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)', 'org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1345)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)', 'org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:480)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)', 'org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1247)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)', 'org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)', 'org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:174)', 'org.eclipse.jetty.server.handler.HandlerList.handle(HandlerList.java:61)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.Server.handle(Server.java:502)', 'org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:364)', 'org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)', 'org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ssl.SslConnection$DecryptedEndPoint.onFillable(SslConnection.java:411)', 'org.eclipse.jetty.io.ssl.SslConnection.onFillable(SslConnection.java:305)', 'org.eclipse.jetty.io.ssl.SslConnection$2.succeeded(SslConnection.java:159)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)', 'org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)', 'org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:765)', 'org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:683)', 'java.lang.Thread.run(Thread.java:748)']}})
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/site-packages/celery/app/trace.py", line 412, in trace_task
    R = retval = fun(*args, **kwargs)
  File "/usr/local/lib/python3.8/site-packages/celery/app/trace.py", line 704, in __protected_call__
    return self.run(*args, **kwargs)
  File "/usr/src/app/routes/server/tasks.py", line 34, in create_task
    df = pd.read_sql(gen_sql(), presto_conn)
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 484, in read_sql
    return pandas_sql.read_query(
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 1756, in read_query
    data = self._fetchall_as_list(cursor)
  File "/usr/local/lib/python3.8/site-packages/pandas/io/sql.py", line 1769, in _fetchall_as_list
    result = cur.fetchall()
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 137, in fetchall
    return list(iter(self.fetchone, None))
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 106, in fetchone
    self._fetch_while(lambda: not self._data and self._state != self._STATE_FINISHED)
  File "/usr/local/lib/python3.8/site-packages/pyhive/common.py", line 46, in _fetch_while
    self._fetch_more()
  File "/usr/local/lib/python3.8/site-packages/pyhive/presto.py", line 308, in _fetch_more
    self._process_response(self._requests_session.get(self._nextUri, **self._requests_kwargs))
  File "/usr/local/lib/python3.8/site-packages/pyhive/presto.py", line 349, in _process_response
    raise DatabaseError(response_json['error'])
pyhive.exc.DatabaseError: {'message': 'Query killed. Message: Killed via web UI', 'errorCode': 38, 'errorName': 'ADMINISTRATIVELY_KILLED', 'errorType': 'USER_ERROR', 'failureInfo': {'type': 'com.facebook.presto.spi.PrestoException', 'message': 'Query killed. Message: Killed via web UI', 'suppressed': [], 'stack': ['com.facebook.presto.connector.system.KillQueryProcedure.createKillQueryException(KillQueryProcedure.java:92)', 'com.facebook.presto.server.QueryResource.killQuery(QueryResource.java:96)', 'sun.reflect.GeneratedMethodAccessor1685.invoke(Unknown Source)', 'sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)', 'java.lang.reflect.Method.invoke(Method.java:498)', 'org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory.lambda$static$0(ResourceMethodInvocationHandlerFactory.java:76)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:148)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:191)', 'org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$ResponseOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:200)', 'org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:103)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:493)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:415)', 'org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:104)', 'org.glassfish.jersey.server.ServerRuntime$1.run(ServerRuntime.java:277)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:272)', 'org.glassfish.jersey.internal.Errors$1.call(Errors.java:268)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:316)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:298)', 'org.glassfish.jersey.internal.Errors.process(Errors.java:268)', 'org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:289)', 'org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:256)', 'org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:703)', 'org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:416)', 'org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:370)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:389)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:342)', 'org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:229)', 'org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:867)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1623)', 'com.facebook.presto.server.security.AuthenticationFilter.doFilter(AuthenticationFilter.java:69)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TraceTokenFilter.doFilter(TraceTokenFilter.java:63)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'com.facebook.airlift.http.server.TimingFilter.doFilter(TimingFilter.java:51)', 'org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1610)', 'org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:540)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)', 'org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:703)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)', 'org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1345)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)', 'org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:480)', 'org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)', 'org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1247)', 'org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)', 'org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)', 'org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:174)', 'org.eclipse.jetty.server.handler.HandlerList.handle(HandlerList.java:61)', 'org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)', 'org.eclipse.jetty.server.Server.handle(Server.java:502)', 'org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:364)', 'org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)', 'org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ssl.SslConnection$DecryptedEndPoint.onFillable(SslConnection.java:411)', 'org.eclipse.jetty.io.ssl.SslConnection.onFillable(SslConnection.java:305)', 'org.eclipse.jetty.io.ssl.SslConnection$2.succeeded(SslConnection.java:159)', 'org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)', 'org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)', 'org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)', 'org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)', 'org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:765)', 'org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:683)', 'java.lang.Thread.run(Thread.java:748)']}}
[2021-01-22 03:22:39,648: WARNING/ForkPoolWorker-8] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 03:22:39,657: INFO/ForkPoolWorker-8] Task create_task[52839b5b-6037-4788-a109-82da93b757e9] succeeded in 104.44338480000079s: True
[2021-01-22 03:22:39,679: WARNING/ForkPoolWorker-7] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 03:22:39,678: WARNING/ForkPoolWorker-7] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 03:22:39,680: WARNING/ForkPoolWorker-8] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 03:22:39,683: WARNING/ForkPoolWorker-7] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 03:22:39,684: WARNING/ForkPoolWorker-7] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 03:22:39,685: INFO/ForkPoolWorker-7] Task create_task[692d40c8-11ea-42e4-ab4b-507f0ee81ac1] succeeded in 105.68998450000072s: True
[2021-01-22 03:22:39,686: INFO/ForkPoolWorker-7] Task create_task[ac202d15-bfbe-4f6a-897d-71466c815d9b] succeeded in 105.12543530000039s: True
[2021-01-22 03:22:39,687: INFO/ForkPoolWorker-8] Task create_task[75d7797a-31fc-43d5-a56c-09e79a92c1ba] succeeded in 104.61483749999934s: True
[2021-01-22 03:22:39,689: INFO/ForkPoolWorker-7] Task create_task[4fc4d2c4-1952-4cfe-a4b1-daa18e812435] succeeded in 105.26515610000024s: True
[2021-01-22 03:22:39,691: INFO/ForkPoolWorker-7] Task create_task[fa733614-7aac-4906-817f-6420f80f553e] succeeded in 105.38151419999849s: True
[2021-01-22 03:22:39,694: WARNING/ForkPoolWorker-7] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 03:22:39,698: INFO/ForkPoolWorker-7] Task create_task[916124c1-2d97-4801-b903-ae1dfac5b594] succeeded in 104.8800425999998s: True
[2021-01-22 03:22:39,699: WARNING/ForkPoolWorker-8] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 03:22:39,705: INFO/ForkPoolWorker-8] Task create_task[e76eb3d1-995f-457a-a06a-56659fe12964] succeeded in 104.39836410000134s: True
[2021-01-22 04:58:08,605: INFO/MainProcess] Connected to redis://redis:6379/0
[2021-01-22 04:58:08,614: INFO/MainProcess] mingle: searching for neighbors
[2021-01-22 04:58:09,658: INFO/MainProcess] mingle: all alone
[2021-01-22 04:58:09,673: INFO/MainProcess] celery@a8a2fbc976b4 ready.
[2021-01-22 04:58:14,059: INFO/MainProcess] Events of group {task} enabled by remote.
[2021-01-22 04:58:35,604: INFO/MainProcess] Received task: create_task[b9367abe-caac-4c7d-9c93-5becfe153515]  
[2021-01-22 04:58:45,620: WARNING/ForkPoolWorker-7] [INFO - TASKTYPE] : 1
[2021-01-22 04:58:45,622: WARNING/ForkPoolWorker-7] [INFO - 2021-01-22 04:58:45.622878] -> @ Start pull data from Presto
[2021-01-22 04:58:45,625: INFO/ForkPoolWorker-7] 
        WITH tmp AS (
            SELECT serial_number,dcm_date,dcm_date_time,test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,
            dcm_moba_code,dcm_line_id,pn_capacity,test_type,contextid,head_id,radius_id,dcm_eval_code,
            hiest_rro_frq_1,hiest_rro_frq_2,hiest_rro_frq_3,hiest_rro_frq_4,hiest_rro_frq_5,
            hiest_rro_mag_1,hiest_rro_mag_2,hiest_rro_mag_3,hiest_rro_mag_4,hiest_rro_mag_5,
            CASE WHEN hiest_rro_mag_1>hiest_rro_mag_2 and hiest_rro_mag_1>hiest_rro_mag_3 and hiest_rro_mag_1>hiest_rro_mag_4 and hiest_rro_mag_1>hiest_rro_mag_5 THEN hiest_rro_mag_1
                WHEN hiest_rro_mag_2>hiest_rro_mag_1 and hiest_rro_mag_2>hiest_rro_mag_3 and hiest_rro_mag_2>hiest_rro_mag_4 and hiest_rro_mag_2>hiest_rro_mag_5 THEN hiest_rro_mag_2
                WHEN hiest_rro_mag_3>hiest_rro_mag_1 and hiest_rro_mag_3>hiest_rro_mag_2 and hiest_rro_mag_3>hiest_rro_mag_4 and hiest_rro_mag_3>hiest_rro_mag_5 THEN hiest_rro_mag_3
                WHEN hiest_rro_mag_4>hiest_rro_mag_1 and hiest_rro_mag_4>hiest_rro_mag_2 and hiest_rro_mag_4>hiest_rro_mag_3 and hiest_rro_mag_4>hiest_rro_mag_5 THEN hiest_rro_mag_4
                WHEN hiest_rro_mag_5 >hiest_rro_mag_1 and hiest_rro_mag_5>hiest_rro_mag_2 and hiest_rro_mag_5>hiest_rro_mag_3 and hiest_rro_mag_5>hiest_rro_mag_4 THEN hiest_rro_mag_5
                END AS Maxmag_20xTo30x,failcount_PE1,groups,tester_id,testerID,groupMBA
        FROM(
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_epbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_epbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
            UNION ALL
                SELECT xsm.serial_number,
                    xsm.test_start_date_time,
                    xsm.dcm_date_time,
                    xsm.dcm_date,
                    xsm.batch_date_time,
                    xsm.batch_date,
                    xsm.startdt,
                    xsm.pass_fail,
                    xsm.tester_id,
                    xsm.dcm_moba_code,
                    xsm.dcm_line_id,
                    xsm.pn_capacity,
                    xrd.test_type,
                    xrd.contextid,
                    xrd.head_id,
                    xrd.radius_id,
                    xrd.dcm_eval_code,
                    xrd.hiest_rro_frq_1,
                    xrd.hiest_rro_frq_2,
                    xrd.hiest_rro_frq_3,
                    xrd.hiest_rro_frq_4,
                    xrd.hiest_rro_frq_5,
                    xrd.hiest_rro_mag_1/(84000.0*4) AS hiest_rro_mag_1,
                    xrd.hiest_rro_mag_2/(84000.0*4) AS hiest_rro_mag_2,
                    xrd.hiest_rro_mag_3/(84000.0*4) AS hiest_rro_mag_3,
                    xrd.hiest_rro_mag_4/(84000.0*4) AS hiest_rro_mag_4,
                    xrd.hiest_rro_mag_5/(84000.0*4) AS hiest_rro_mag_5,
                    case when xrd.hiest_rro_frq_1 between 24 and 29 and xrd.hiest_rro_mag_1 > 700000 then 1 else 0 end as failcount_PE1,
                    case when xsm.serial_number in ('WX12A70D05NS','WX12A70D0KD3','WXE2A709S70E','WXE2A709S85A','WXE2A709S907','WXE2A709S99Y','WXE2A709S9J5','WXE2A709SC04','WXE2A709SD3X'
                                                        ,'WXE2A709SFY6','WXE2A709SKLR','WXE2A709SNCZ','WXE2A709SNN8','WXE2A709SPFH','WXE2A709ST87','WXE2A709SVCK','WXE2A70RYTFV','WXE2A80E0AA8'
                                                        ,'WXE2A80E0FJ2','WXE2A80E0J0U','WXK2A80575LD','WXL2A801HCYU','WXL2A801HDRL','WXL2A801HF6Z','WXL2A801HRLD','WXL2A801HSUS','WXL2A801HUT2'
                                                        ,'WXL2A801HV7E','WXL2A801HV7K','WXL2A801HZSN') then 'OQA glist'
                            else 'passer' end as groups,
                    case when substring(xsm.tester_id,1,2) = 'EB' then 'Neptune' when substring(xsm.tester_id,1,2) = 'PB' then 'Optimus' end as testerID,
                    case when xsm.dcm_moba_code in ('6','S') then 'Nidec' when xsm.dcm_moba_code = '9' then 'PMDM' else 'NA' end as groupMBA
                FROM (
                    (SELECT serial_number,
                            product_name,
                            test_start_date_time,
                            dcm_date_time,
                            dcm_date,
                            batch_date_time,
                            batch_date,
                            startdt,
                            test_type,
                            tester_id,
                            pass_fail,
                            family_id,
                            dcm_moba_code,
                            dcm_line_id,
                            pn_capacity
                    FROM xmms.vwb_xpbe_summary
                    WHERE product IN ('palmer72')
                    AND   site IN ('wdb4')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   pass_fail = 'P'
                    --AND test_type = 764
                    --AND batch_date_time in (SELECT distinct MAX(batch_date_time) over(partition by serial_number) from xmms.vwb_epbe_summary WHERE product IN ('palmer72') and serial_number  in('WXD2A40DL48F','WXE2A709SC04'))                                
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xsm
                INNER join
                    (SELECT serial_number,
                            startdt,
                            test_start_date_time,
                            test_type,
                            contextid,
                            test_phase_id,
                            head_id,
                            radius_id,
                            dcm_eval_code,
                            site,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_frq_1 ELSE 0 END) AS hiest_rro_frq_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_frq_2 ELSE 0 END) AS hiest_rro_frq_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_frq_3 ELSE 0 END) AS hiest_rro_frq_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_frq_4 ELSE 0 END) AS hiest_rro_frq_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_frq_5 ELSE 0 END) AS hiest_rro_frq_5,
                            (case when hiest_rro_frq_1 between 20 and 30 THEN hiest_rro_mag_1 ELSE 0 END) AS hiest_rro_mag_1,
                            (case when hiest_rro_frq_2 between 20 and 30 THEN hiest_rro_mag_2 ELSE 0 END) AS hiest_rro_mag_2,
                            (case when hiest_rro_frq_3 between 20 and 30 THEN hiest_rro_mag_3 ELSE 0 END) AS hiest_rro_mag_3,
                            (case when hiest_rro_frq_4 between 20 and 30 THEN hiest_rro_mag_4 ELSE 0 END) AS hiest_rro_mag_4,
                            (case when hiest_rro_frq_5 between 20 and 30 THEN hiest_rro_mag_5 ELSE 0 END) AS hiest_rro_mag_5
                    FROM xmms.vwb_xpbe_radius
                    WHERE product IN ('palmer72')
                    --AND   startdt BETWEEN '20201110' AND '20201122'
                    AND startdt BETWEEN DATE_FORMAT(DATE_ADD('month',-3,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
                    AND   test_type IN (764,762)
                    AND   contextid IN (55,54)
                    AND hiest_rro_frq_1 is not null
                    --AND serial_number in('WXN2A80178HN','WX92E60ED3WN','WXE2A70RY51E')
                    ) AS xrd
                ON xsm.serial_number = trim(xrd.serial_number)
                AND xsm.test_start_date_time = xrd.test_start_date_time
                AND xsm.test_type = xrd.test_type
                )
        )

        )
        select dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity AS CRNO_MBA_CAP
        ,count(*) as Total_Qty
        --,sum(failcount_PElimit) as failcount_limit1
        --,sum(failcount_PElimit) *100.0/count(*) as failrate_limit1
        --,sum(failcount_FEALimit) as failcount_limit2
        --,sum(failcount_FEALimit) *100.0/count(*) as failrate_limit2
        --,sum(failcount_FEA2Limit) as failcount_limit3
        --,sum(failcount_FEA2Limit) *100.0/count(*) as failrate_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) as failcount_limit3
        --,sum(case when failcount_PElimit = 1 or failcount_FEALimit = 1 then 1 else 0 end) *100.0/count(*) as failrate_limit3
        
        ,ROUND(AVG(failcount_Q1Limit)*100,2) as Q1_FR
        --,AVG(failcount_Q2Limit)*100 as failcount_Q2
        --,AVG(failcount_Q3Limit)*100 as failcount_Q3
        --,AVG(failcount_Q4Limit)*100 as failcount_Q4
        
        
        from (
                SELECT serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                    Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 or DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_FEALimit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 then 1 else 0 end) as failcount_FEA2Limit,
                    
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q1Limit,
                    max(case when Maxmag_20xTo30x_POSBI >= 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q2Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag <= 0.34 then 1 else 0 end) as failcount_Q3Limit,
                    max(case when Maxmag_20xTo30x_POSBI < 1.10 and DeltaMaxMag > 0.34 then 1 else 0 end) as failcount_Q4Limit,
                    row_number() over(partition by serial_number,dcm_date order by batch_date asc) AS Flg_bt_date,
                    groupMBA, groups,tester_id,testerID
                FROM (
                        SELECT BI.serial_number,
                                POS_BI.dcm_eval_code,
                                POS_BI.dcm_date,
                                POS_BI.dcm_date_time,
                                BI.test_start_date_time,
                                BI.batch_date_time,
                                BI.batch_date,
                                POS_BI.startdt,
                                BI.pass_fail,
                                BI.dcm_moba_code,
                                BI.dcm_line_id,
                                BI.pn_capacity,
                                BI.Maxmag_20xTo30x_BI,
                                POS_BI.Maxmag_20xTo30x_POSBI,
                                (POS_BI.Maxmag_20xTo30x_POSBI-BI.Maxmag_20xTo30x_BI) AS DeltaMaxMag,
                                POS_BI.failcount_PElimit,
                                BI.groupMBA,BI.groups,BI.tester_id,BI.testerID

                            FROM(
                                    (SELECT serial_number,dcm_eval_code,
                                        test_start_date_time,
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_BI,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 762
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS BI
                    
                                INNER JOIN
                
                                    (SELECT serial_number,
                                        dcm_eval_code, 
                                        DATE_FORMAT(cast(dcm_date as timestamp),'%Y%m%d') AS dcm_date,
                                        dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d') AS batch_date,
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,
                                        MAX(Maxmag_20xTo30x) AS Maxmag_20xTo30x_POSBI,
                                        MAX(failcount_PE1) as failcount_PElimit,
                                        groups,tester_id,testerID,groupMBA
                                        From tmp
                                        where test_type = 764
                                    group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, 
                                        test_start_date_time,
                                        batch_date_time,
                                        DATE_FORMAT(cast(batch_date as timestamp),'%Y%m%d'),
                                        startdt,
                                        pass_fail,
                                        dcm_moba_code,
                                        dcm_line_id,
                                        pn_capacity,
                                        test_type,groups,tester_id,testerID,groupMBA
                                    ) AS  POS_BI
                                    ON BI.serial_number = POS_BI.serial_number
                                    and BI.batch_date = POS_BI.batch_date
                        ) 
                    ) AS SubA
                Group by serial_number,dcm_eval_code, dcm_date, dcm_date_time, test_start_date_time,batch_date_time,batch_date,startdt,pass_fail,dcm_moba_code,dcm_line_id,pn_capacity,
                Maxmag_20xTo30x_BI,Maxmag_20xTo30x_POSBI,DeltaMaxMag,failcount_PElimit,groupMBA, groups,tester_id,testerID
        )
        where  dcm_date BETWEEN DATE_FORMAT(DATE_ADD('day',-7,CURRENT_DATE),'%Y%m%d') AND DATE_FORMAT(CURRENT_DATE,'%Y%m%d')
            AND Flg_bt_date = 1
        Group by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
        HAVING COUNT(*) >= 500
        Order by dcm_date,dcm_line_id||'_'||groupMBA||'_'||pn_capacity
    
[2021-01-22 04:59:04,597: WARNING/ForkPoolWorker-7] dcm_date      CRNO_MBA_CAP  Total_Qty  Q1_FR
0  20210115  9357A_Nidec_1000       4954   1.11
1  20210115   9357A_PMDM_1000        856   0.93
2  20210115  9357B_Nidec_1000       6682   0.94
3  20210115   9357B_PMDM_1000       1115   0.72
4  20210116  9357A_Nidec_1000       2790   1.04
[2021-01-22 04:59:04,602: INFO/ForkPoolWorker-7] Task create_task[b9367abe-caac-4c7d-9c93-5becfe153515] succeeded in 28.99370049999925s: True
